/******************************************************************************
 *
 * (c) Copyright 2010-12 Xilinx, Inc. All rights reserved.
 *
 * This file contains confidential and proprietary information of Xilinx, Inc.
 * and is protected under U.S. and international copyright and other
 * intellectual property laws.
 *
 * DISCLAIMER
 * This disclaimer is not a license and does not grant any rights to the
 * materials distributed herewith. Except as otherwise provided in a valid
 * license issued to you by Xilinx, and to the maximum extent permitted by
 * applicable law: (1) THESE MATERIALS ARE MADE AVAILABLE "AS IS" AND WITH ALL
 * FAULTS, AND XILINX HEREBY DISCLAIMS ALL WARRANTIES AND CONDITIONS, EXPRESS,
 * IMPLIED, OR STATUTORY, INCLUDING BUT NOT LIMITED TO WARRANTIES OF
 * MERCHANTABILITY, NON-INFRINGEMENT, OR FITNESS FOR ANY PARTICULAR PURPOSE;
 * and (2) Xilinx shall not be liable (whether in contract or tort, including
 * negligence, or under any other theory of liability) for any loss or damage
 * of any kind or nature related to, arising under or in connection with these
 * materials, including for any direct, or any indirect, special, incidental,
 * or consequential loss or damage (including loss of data, profits, goodwill,
 * or any type of loss or damage suffered as a result of any action brought by
 * a third party) even if such damage or loss was reasonably foreseeable or
 * Xilinx had been advised of the possibility of the same.
 *
 * CRITICAL APPLICATIONS
 * Xilinx products are not designed or intended to be fail-safe, or for use in
 * any application requiring fail-safe performance, such as life-support or
 * safety devices or systems, Class III medical devices, nuclear facilities,
 * applications related to the deployment of airbags, or any other applications
 * that could lead to death, personal injury, or severe property or
 * environmental damage (individually and collectively, "Critical
 * Applications"). Customer assumes the sole risk and liability of any use of
 * Xilinx products in Critical Applications, subject only to applicable laws
 * and regulations governing limitations on product liability.
 *
 * THIS COPYRIGHT NOTICE AND DISCLAIMER MUST BE RETAINED AS PART OF THIS FILE
 * AT ALL TIMES.
 *
 ******************************************************************************/
//----------------------------------------------------------------
//
// Design Name:         I2C Utilities
// Target Devices:      Zynq-7
//
// Tool versions:       ISE 14.1
//
// Description:         I2C Utilities.
//                      - I2C Multiplexer
//                      - HDMI
//						- Clock Synthesizer
//
//----------------------------------------------------------------

#include <stdlib.h>

#include "xil_printf.h"
#include "xstatus.h"
#include "i2c_utils.h"
#include "fsbl_debug.h"

#define IIC_DEBUG

#ifdef IIC_DEBUG
#define  iic_debug_xil_printf                       xil_printf
#else
#define  iic_debug_xil_printf(msg, args...) do {  } while (0)
#endif

#define ZC702_HDMI_ADDR1     0x39 // (Sil9134)
#define ZC702_HDMI_ADDR2	 0x3d // (Sil9134)


// I2C Config Struct
typedef struct {
	u8 Reg;
	u8 Data;
	u8 Init;
} ZC702_I2C_CONFIG;


// I2C Config Struct
typedef struct {
	u8 Addr;
	u8 Reg;
	u8 Data;
	u8 Init;
} ZC702_I2C_CONFIG2;


// Common FRU Header
struct fru_header {
	u8 version;
	struct	{
		u8 internal;
		u8 chassis;
		u8 board;
		u8 product;
		u8 multi;
	} offset;
	u8 pad;
	u8 checksum;
};


// HDMI 9134 1080P Separate Sync 422 422
#define ZC702_HDMI_OUT_LEN1  3
ZC702_I2C_CONFIG zc702_hdmi_out_config1[ZC702_HDMI_OUT_LEN1] =
{

		{0x05, 0x00, 0x01}, //
		{0x05, 0x00, 0x00}, //
		{0x08, 0x00, 0xfd} //

};

#define ZC702_HDMI_OUT_LEN2  11
ZC702_I2C_CONFIG zc702_hdmi_out_config2[ZC702_HDMI_OUT_LEN2] =
{
		{0x2f, 0x00, 0x21},
		{0x3e, 0x00, 0x03}, //
		{0x40, 0x00, 0x82}, //
		{0x41, 0x00, 0x02},
		{0x42, 0x00, 0x0d},
		//{0x43, 0x00, 0xf7},//rgb checksum value
		//{0x44, 0x00, 0x10},//rgb
		{0x43, 0x00, 0xe7},	// yuv422 checksum value
		{0x44, 0x00, 0x20},	// yuv422
		{0x45, 0x00, 0x68},
		{0x46, 0x00, 0x00},
		{0x47, 0x00, 0x00},
		{0x3d, 0x00, 0x07}
};

#define OV_CMOS_CONFIG_720P

// RHJ add 720p
// OV cmos config table
#ifdef OV_CMOS_CONFIG_720P

#define IIC_ADDR	0x3c
#define	Config_Len_C 	252
#define Config_Len_L	3
unsigned char CMOS_Config[Config_Len_C][Config_Len_L] = {

		{0x31,0x03,0x11},
		{0x30,0x08,0x82},
		{0x30,0x08,0x42},
		{0x31,0x03,0x03},
		{0x30,0x17,0xff},
		{0x30,0x18,0xff},
		{0x30,0x34,0x1a},
		{0x30,0x37,0x13},
		{0x31,0x08,0x01},

		{0x36,0x30,0x36},
		{0x36,0x31,0x0e},
		{0x36,0x32,0xe2},
		{0x36,0x33,0x12},
		{0x36,0x21,0xe0},
		{0x37,0x04,0xa0},
		{0x37,0x03,0x5a},
		{0x37,0x15,0x78},
		{0x37,0x17,0x01},
		{0x37,0x0b,0x60},
		{0x37,0x05,0x1a},
		{0x39,0x05,0x02},
		{0x39,0x06,0x10},
		{0x39,0x01,0x0a},
		{0x37,0x31,0x12},
		{0x36,0x00,0x08},
		{0x36,0x01,0x33},
		{0x30,0x2d,0x60},
		{0x36,0x20,0x52},
		{0x37,0x1b,0x20},
		{0x47,0x1c,0x50},
		{0x3a,0x13,0x43},
		{0x3a,0x18,0x00},
		{0x3a,0x19,0xf8},
		{0x36,0x35,0x13},
		{0x36,0x36,0x03},
		{0x36,0x34,0x40},
		{0x36,0x22,0x01},

		{0x3c,0x01,0x34},
		{0x3c,0x04,0x28},
		{0x3c,0x05,0x98},
		{0x3c,0x06,0x00},
		{0x3c,0x07,0x08},
		{0x3c,0x08,0x00},
		{0x3c,0x09,0x1c},
		{0x3c,0x0a,0x9c},
		{0x3c,0x0b,0x40},

		{0x38,0x10,0x00},
		{0x38,0x11,0x10},
		{0x38,0x12,0x00},
		{0x37,0x08,0x64},
		{0x40,0x01,0x02},
		{0x40,0x05,0x1a},
		{0x30,0x00,0x00},
		{0x30,0x04,0xff},
		{0x30,0x0e,0x58},
		{0x30,0x2e,0x00},
		{0x43,0x00,0x00},
		{0x50,0x1f,0x05},
		{0x44,0x0e,0x00},
		{0x50,0x00,0xa7},

		{0x3a,0x0f,0x30},
		{0x3a,0x10,0x28},
		{0x3a,0x1b,0x30},
		{0x3a,0x1e,0x26},
		{0x3a,0x11,0x60},
		{0x3a,0x1f,0x14},

		{0x58,0x00,0x23},
		{0x58,0x01,0x14},
		{0x58,0x02,0x0f},
		{0x58,0x03,0x0f},
		{0x58,0x04,0x12},
		{0x58,0x05,0x26},
		{0x58,0x06,0x0c},
		{0x58,0x07,0x08},
		{0x58,0x08,0x05},
		{0x58,0x09,0x05},
		{0x58,0x0a,0x08},
		{0x58,0x0b,0x0d},
		{0x58,0x0c,0x08},
		{0x58,0x0d,0x03},
		{0x58,0x0e,0x00},
		{0x58,0x0f,0x00},
		{0x58,0x10,0x03},
		{0x58,0x11,0x09},
		{0x58,0x12,0x07},
		{0x58,0x13,0x03},
		{0x58,0x14,0x00},
		{0x58,0x15,0x01},
		{0x58,0x16,0x03},
		{0x58,0x17,0x08},
		{0x58,0x18,0x0d},
		{0x58,0x19,0x08},
		{0x58,0x1a,0x05},
		{0x58,0x1b,0x06},
		{0x58,0x1c,0x08},
		{0x58,0x1d,0x0e},
		{0x58,0x1e,0x29},
		{0x58,0x1f,0x17},
		{0x58,0x20,0x11},
		{0x58,0x21,0x11},
		{0x58,0x22,0x15},
		{0x58,0x23,0x28},
		{0x58,0x24,0x46},
		{0x58,0x25,0x26},
		{0x58,0x26,0x08},
		{0x58,0x27,0x26},
		{0x58,0x28,0x64},
		{0x58,0x29,0x26},
		{0x58,0x2a,0x24},
		{0x58,0x2b,0x22},
		{0x58,0x2c,0x24},
		{0x58,0x2d,0x24},
		{0x58,0x2e,0x06},
		{0x58,0x2f,0x22},
		{0x58,0x30,0x40},
		{0x58,0x31,0x42},
		{0x58,0x32,0x24},
		{0x58,0x33,0x26},
		{0x58,0x34,0x24},
		{0x58,0x35,0x22},
		{0x58,0x36,0x22},
		{0x58,0x37,0x26},
		{0x58,0x38,0x44},
		{0x58,0x39,0x24},
		{0x58,0x3a,0x26},
		{0x58,0x3b,0x28},
		{0x58,0x3c,0x42},
		{0x58,0x3d,0xce},

		{0x51,0x80,0xff},
		{0x51,0x81,0xf2},
		{0x51,0x82,0x00},
		{0x51,0x83,0x14},
		{0x51,0x84,0x25},
		{0x51,0x85,0x24},
		{0x51,0x86,0x09},
		{0x51,0x87,0x09},
		{0x51,0x88,0x09},
		{0x51,0x89,0x75},
		{0x51,0x8a,0x54},
		{0x51,0x8b,0xe0},
		{0x51,0x8c,0xb2},
		{0x51,0x8d,0x42},
		{0x51,0x8e,0x3d},
		{0x51,0x8f,0x56},
		{0x51,0x90,0x46},
		{0x51,0x91,0xf8},
		{0x51,0x92,0x04},
		{0x51,0x93,0x70},
		{0x51,0x94,0xf0},
		{0x51,0x95,0xf0},
		{0x51,0x96,0x03},
		{0x51,0x97,0x01},
		{0x51,0x98,0x04},
		{0x51,0x99,0x12},
		{0x51,0x9a,0x04},
		{0x51,0x9b,0x00},
		{0x51,0x9c,0x06},
		{0x51,0x9d,0x82},
		{0x51,0x9e,0x38},

		{0x54,0x80,0x01},
		{0x54,0x81,0x08},
		{0x54,0x82,0x14},
		{0x54,0x83,0x28},
		{0x54,0x84,0x51},
		{0x54,0x85,0x65},
		{0x54,0x86,0x71},
		{0x54,0x87,0x7d},
		{0x54,0x88,0x87},
		{0x54,0x89,0x91},
		{0x54,0x8a,0x9a},
		{0x54,0x8b,0xaa},
		{0x54,0x8c,0xb8},
		{0x54,0x8d,0xcd},
		{0x54,0x8e,0xdd},
		{0x54,0x8f,0xea},
		{0x54,0x90,0x1d},

		{0x53,0x81,0x1e},
		{0x53,0x82,0x5b},
		{0x53,0x83,0x08},
		{0x53,0x84,0x0a},
		{0x53,0x85,0x7e},
		{0x53,0x86,0x88},
		{0x53,0x87,0x7c},
		{0x53,0x88,0x6c},
		{0x53,0x89,0x10},
		{0x53,0x8a,0x01},
		{0x53,0x8b,0x98},

		{0x55,0x80,0x06},
		{0x55,0x83,0x40},
		{0x55,0x84,0x10},
		{0x55,0x89,0x10},
		{0x55,0x8a,0x00},
		{0x55,0x8b,0xf8},
		{0x50,0x1d,0x40},

		{0x53,0x00,0x08},
		{0x53,0x01,0x30},
		{0x53,0x02,0x10},
		{0x53,0x03,0x00},
		{0x53,0x04,0x08},
		{0x53,0x05,0x30},
		{0x53,0x06,0x08},
		{0x53,0x07,0x16},
		{0x53,0x09,0x08},
		{0x53,0x0a,0x30},
		{0x53,0x0b,0x04},
		{0x53,0x0c,0x06},

		{0x50,0x25,0x00},
		{0x30,0x08,0x02},

		{0x30,0x35,0x21},//0x41,0x21
		{0x30,0x36,0x69},
		{0x3c,0x07,0x07},
		{0x38,0x20,0x41},
		{0x38,0x21,0x07},
		{0x38,0x14,0x31},
		{0x38,0x15,0x31},
		{0x38,0x00,0x00},
		{0x38,0x01,0x00},
		{0x38,0x02,0x00},
		{0x38,0x03,0xfa},
		{0x38,0x04,0x0a},
		{0x38,0x05,0x3f},
		{0x38,0x06,0x06},
		{0x38,0x07,0xa9},
		{0x38,0x08,0x05},
		{0x38,0x09,0x00},
		{0x38,0x0a,0x02},
		{0x38,0x0b,0xd0},
		{0x38,0x0c,0x07},
		{0x38,0x0d,0x64},
		{0x38,0x0e,0x02},
		{0x38,0x0f,0xe4},
		{0x38,0x13,0x04},
		{0x36,0x18,0x00},
		{0x36,0x12,0x29},
		{0x37,0x09,0x52},
		{0x37,0x0c,0x03},
		{0x3a,0x02,0x02},
		{0x3a,0x03,0xe0},
		{0x3a,0x14,0x02},
		{0x3a,0x15,0xe0},
		{0x40,0x04,0x02},
		{0x30,0x02,0x1c},
		{0x30,0x06,0xc3},
		{0x47,0x13,0x03},
		{0x44,0x07,0x04},
		{0x46,0x0b,0x37},
		{0x46,0x0c,0x20},
		{0x48,0x37,0x16},
		{0x38,0x24,0x04},
		{0x50,0x01,0x83},
		{0x35,0x03,0x00},

		{0x50,0x3d,0x00}


};

#endif


#ifdef OV_CMOS_CONFIG_480P

// RHJ add 480p
// OV cmos config table
#define IIC_ADDR	0x3c
#define	Config_Len_C 	252
#define Config_Len_L	3
unsigned char CMOS_Config[Config_Len_C][Config_Len_L] = {

		{0x31,0x03,0x11},
		{0x30,0x08,0x82},
		{0x30,0x08,0x42},
		{0x31,0x03,0x03},
		{0x30,0x17,0xff},
		{0x30,0x18,0xff},
		{0x30,0x34,0x1a},
		{0x30,0x37,0x13},
		{0x31,0x08,0x01},

		{0x36,0x30,0x36},
		{0x36,0x31,0x0e},
		{0x36,0x32,0xe2},
		{0x36,0x33,0x12},
		{0x36,0x21,0xe0},
		{0x37,0x04,0xa0},
		{0x37,0x03,0x5a},
		{0x37,0x15,0x78},
		{0x37,0x17,0x01},
		{0x37,0x0b,0x60},
		{0x37,0x05,0x1a},
		{0x39,0x05,0x02},
		{0x39,0x06,0x10},
		{0x39,0x01,0x0a},
		{0x37,0x31,0x12},
		{0x36,0x00,0x08},
		{0x36,0x01,0x33},
		{0x30,0x2d,0x60},
		{0x36,0x20,0x52},
		{0x37,0x1b,0x20},
		{0x47,0x1c,0x50},
		{0x3a,0x13,0x43},
		{0x3a,0x18,0x00},
		{0x3a,0x19,0xf8},
		{0x36,0x35,0x13},
		{0x36,0x36,0x03},
		{0x36,0x34,0x40},
		{0x36,0x22,0x01},

		{0x3c,0x01,0x34},
		{0x3c,0x04,0x28},
		{0x3c,0x05,0x98},
		{0x3c,0x06,0x00},
		{0x3c,0x07,0x08},
		{0x3c,0x08,0x00},
		{0x3c,0x09,0x1c},
		{0x3c,0x0a,0x9c},
		{0x3c,0x0b,0x40},

		{0x38,0x10,0x00},
		{0x38,0x11,0x10},
		{0x38,0x12,0x00},
		{0x37,0x08,0x64},
		{0x40,0x01,0x02},
		{0x40,0x05,0x1a},
		{0x30,0x00,0x00},
		{0x30,0x04,0xff},
		{0x30,0x0e,0x58},
		{0x30,0x2e,0x00},
		{0x43,0x00,0x00},//0x30, YUV 422 YUYV
		{0x50,0x1f,0x05},//0x00, YUV 422
		{0x44,0x0e,0x00},
		{0x50,0x00,0xa7},

		{0x3a,0x0f,0x30},
		{0x3a,0x10,0x28},
		{0x3a,0x1b,0x30},
		{0x3a,0x1e,0x26},
		{0x3a,0x11,0x60},
		{0x3a,0x1f,0x14},

		{0x58,0x00,0x23},
		{0x58,0x01,0x14},
		{0x58,0x02,0x0f},
		{0x58,0x03,0x0f},
		{0x58,0x04,0x12},
		{0x58,0x05,0x26},
		{0x58,0x06,0x0c},
		{0x58,0x07,0x08},
		{0x58,0x08,0x05},
		{0x58,0x09,0x05},
		{0x58,0x0a,0x08},
		{0x58,0x0b,0x0d},
		{0x58,0x0c,0x08},
		{0x58,0x0d,0x03},
		{0x58,0x0e,0x00},
		{0x58,0x0f,0x00},
		{0x58,0x10,0x03},
		{0x58,0x11,0x09},
		{0x58,0x12,0x07},
		{0x58,0x13,0x03},
		{0x58,0x14,0x00},
		{0x58,0x15,0x01},
		{0x58,0x16,0x03},
		{0x58,0x17,0x08},
		{0x58,0x18,0x0d},
		{0x58,0x19,0x08},
		{0x58,0x1a,0x05},
		{0x58,0x1b,0x06},
		{0x58,0x1c,0x08},
		{0x58,0x1d,0x0e},
		{0x58,0x1e,0x29},
		{0x58,0x1f,0x17},
		{0x58,0x20,0x11},
		{0x58,0x21,0x11},
		{0x58,0x22,0x15},
		{0x58,0x23,0x28},
		{0x58,0x24,0x46},
		{0x58,0x25,0x26},
		{0x58,0x26,0x08},
		{0x58,0x27,0x26},
		{0x58,0x28,0x64},
		{0x58,0x29,0x26},
		{0x58,0x2a,0x24},
		{0x58,0x2b,0x22},
		{0x58,0x2c,0x24},
		{0x58,0x2d,0x24},
		{0x58,0x2e,0x06},
		{0x58,0x2f,0x22},
		{0x58,0x30,0x40},
		{0x58,0x31,0x42},
		{0x58,0x32,0x24},
		{0x58,0x33,0x26},
		{0x58,0x34,0x24},
		{0x58,0x35,0x22},
		{0x58,0x36,0x22},
		{0x58,0x37,0x26},
		{0x58,0x38,0x44},
		{0x58,0x39,0x24},
		{0x58,0x3a,0x26},
		{0x58,0x3b,0x28},
		{0x58,0x3c,0x42},
		{0x58,0x3d,0xce},

		{0x51,0x80,0xff},
		{0x51,0x81,0xf2},
		{0x51,0x82,0x00},
		{0x51,0x83,0x14},
		{0x51,0x84,0x25},
		{0x51,0x85,0x24},
		{0x51,0x86,0x09},
		{0x51,0x87,0x09},
		{0x51,0x88,0x09},
		{0x51,0x89,0x75},
		{0x51,0x8a,0x54},
		{0x51,0x8b,0xe0},
		{0x51,0x8c,0xb2},
		{0x51,0x8d,0x42},
		{0x51,0x8e,0x3d},
		{0x51,0x8f,0x56},
		{0x51,0x90,0x46},
		{0x51,0x91,0xf8},
		{0x51,0x92,0x04},
		{0x51,0x93,0x70},
		{0x51,0x94,0xf0},
		{0x51,0x95,0xf0},
		{0x51,0x96,0x03},
		{0x51,0x97,0x01},
		{0x51,0x98,0x04},
		{0x51,0x99,0x12},
		{0x51,0x9a,0x04},
		{0x51,0x9b,0x00},
		{0x51,0x9c,0x06},
		{0x51,0x9d,0x82},
		{0x51,0x9e,0x38},

		{0x54,0x80,0x01},
		{0x54,0x81,0x08},
		{0x54,0x82,0x14},
		{0x54,0x83,0x28},
		{0x54,0x84,0x51},
		{0x54,0x85,0x65},
		{0x54,0x86,0x71},
		{0x54,0x87,0x7d},
		{0x54,0x88,0x87},
		{0x54,0x89,0x91},
		{0x54,0x8a,0x9a},
		{0x54,0x8b,0xaa},
		{0x54,0x8c,0xb8},
		{0x54,0x8d,0xcd},
		{0x54,0x8e,0xdd},
		{0x54,0x8f,0xea},
		{0x54,0x90,0x1d},

		{0x53,0x81,0x1e},
		{0x53,0x82,0x5b},
		{0x53,0x83,0x08},
		{0x53,0x84,0x0a},
		{0x53,0x85,0x7e},
		{0x53,0x86,0x88},
		{0x53,0x87,0x7c},
		{0x53,0x88,0x6c},
		{0x53,0x89,0x10},
		{0x53,0x8a,0x01},
		{0x53,0x8b,0x98},

		{0x55,0x80,0x06},
		{0x55,0x83,0x40},
		{0x55,0x84,0x10},
		{0x55,0x89,0x10},
		{0x55,0x8a,0x00},
		{0x55,0x8b,0xf8},
		{0x50,0x1d,0x40},

		{0x53,0x00,0x08},
		{0x53,0x01,0x30},
		{0x53,0x02,0x10},
		{0x53,0x03,0x00},
		{0x53,0x04,0x08},
		{0x53,0x05,0x30},
		{0x53,0x06,0x08},
		{0x53,0x07,0x16},
		{0x53,0x09,0x08},
		{0x53,0x0a,0x30},
		{0x53,0x0b,0x04},
		{0x53,0x0c,0x06},

		{0x50,0x25,0x00},
		{0x30,0x08,0x02},

		{0x30,0x35,0x41},//0x41
		{0x30,0x36,0x72},//
		{0x3c,0x07,0x08},
		{0x38,0x20,0x41},
		{0x38,0x21,0x07},
		{0x38,0x14,0x31},
		{0x38,0x15,0x31},
		{0x38,0x00,0x00},
		{0x38,0x01,0x00},
		{0x38,0x02,0x00},
		{0x38,0x03,0xbe},
		{0x38,0x04,0x0a},
		{0x38,0x05,0x3f},
		{0x38,0x06,0x06},
		{0x38,0x07,0xe4},
		{0x38,0x08,0x03},
		{0x38,0x09,0x20},
		{0x38,0x0a,0x01},
		{0x38,0x0b,0xe0},
		{0x38,0x0c,0x07},
		{0x38,0x0d,0x69},
		{0x38,0x0e,0x03},
		{0x38,0x0f,0x21},
		{0x38,0x13,0x06},
		{0x36,0x18,0x00},
		{0x36,0x12,0x29},
		{0x37,0x09,0x52},
		{0x37,0x0c,0x03},
		{0x3a,0x02,0x09},
		{0x3a,0x03,0x63},
		{0x3a,0x14,0x09},
		{0x3a,0x15,0x63},
		{0x40,0x04,0x02},
		{0x30,0x02,0x1c},
		{0x30,0x06,0xc3},
		{0x47,0x13,0x03},
		{0x44,0x07,0x04},
		{0x46,0x0b,0x35},
		{0x46,0x0c,0x22},
		{0x48,0x37,0x22},
		{0x38,0x24,0x02},
		{0x50,0x01,0xa3},
		{0x35,0x03,0x00},

		{0x50,0x3d,0x00}


};

#endif




int iic_init( XIicPs *IicPs, u16 DeviceId, u32 ClkRate )
{
	int Status;
	XIicPs_Config *IicPs_Config;

	/*
	 * Initialize the IIC driver.
	 */
	IicPs_Config = XIicPs_LookupConfig(DeviceId);
	if (IicPs_Config == NULL) {
		iic_debug_xil_printf("No XIicPs instance found for ID %d\n\r", DeviceId);
		return XST_FAILURE;
	}

	Status = XIicPs_CfgInitialize(IicPs, IicPs_Config, IicPs_Config->BaseAddress);
	if (Status != XST_SUCCESS) {
		iic_debug_xil_printf("XIicPs Initialization failed for ID %d\n\r", DeviceId);
		return XST_FAILURE;
	}

	/*
	 * Set the IIC serial clock rate.
	 */
	Status = XIicPs_SetSClk(IicPs, ClkRate);
	if (Status != XST_SUCCESS) {
		iic_debug_xil_printf("Setting XIicPs clock rate failed for ID %d\n\r", DeviceId);
		return XST_FAILURE;
	}

	return XST_SUCCESS;
}



/*
 * the iic_write2 function was modified as following:
 *
 * u8 Register --> u8 *Register;
 *
 * add the variable " int reg_cnt" to put the 16-bit
 * register address to the writebuffer[0] and writebuffer[1];
 *
 * ByteCount+1 --> ByteCount+2;
 *
 * Author: rhj
 * 2013.07.26
 * */


static int iic_write_cmos( XIicPs *IicPs, u8 Address, u8 *Register,int reg_cnt, u8 *Data, int ByteCount )
{
	u8 *WriteBuffer = (u8 *) malloc((ByteCount+2) * sizeof(u8));
	int Status;
	int i;


	//rhj add here to put the 16-bit register address to the writebuffer[0] and writebuffer[1];

	int j;
	for (j=0;j<reg_cnt;j++){
		WriteBuffer[j] = Register[j];
	}

	/*
	 * A temporary write buffer must be used which contains both the address
	 * and the data to be written, put the address in first
	 */


	for (i = 0; i < ByteCount; i++) {
		WriteBuffer[i+2] = Data[i];
	}


	/*
	 * Wait until bus is idle to start another transfer.
	 */
	while (XIicPs_BusIsBusy(IicPs)) {
		/* NOP */
	}


	/*
	 * Send the buffer using the IIC and check for errors.
	 */
	Status = XIicPs_MasterSendPolled(IicPs, WriteBuffer, ByteCount+2, Address);
	free(WriteBuffer);
	if (Status != XST_SUCCESS) {
		iic_debug_xil_printf("XIicPs_MasterSendPolled error!\n\r");
		return XST_FAILURE;
	}

	return XST_SUCCESS;

}

//RHJ add here
static int iic_write_hdmi( XIicPs *IicPs, u8 Address, u8 Register, u8 *Data, int ByteCount )
{
	u8 *WriteBuffer = (u8 *) malloc((ByteCount+1) * sizeof(u8));
	int Status;
	int i;

	/*
	 * A temporary write buffer must be used which contains both the address
	 * and the data to be written, put the address in first
	 */
	WriteBuffer[0] = Register;
	for (i = 0; i < ByteCount; i++) {
		WriteBuffer[i+1] = Data[i];
	}

	/*
	 * Wait until bus is idle to start another transfer.
	 */
	while (XIicPs_BusIsBusy(IicPs)) {
		/* NOP */
	}

	/*
	 * Send the buffer using the IIC and check for errors.
	 */
	Status = XIicPs_MasterSendPolled(IicPs, WriteBuffer, ByteCount+1, Address);
	free(WriteBuffer);
	if (Status != XST_SUCCESS) {
		iic_debug_xil_printf("XIicPs_MasterSendPolled error!\n\r");
		return XST_FAILURE;
	}

	return XST_SUCCESS;
}



static void iic_writex( XIicPs *IicPs, u8 Address, ZC702_I2C_CONFIG Config[], u32 Length )
{
	int i;

	for ( i = 0; i < Length; i++ )
	{
		iic_write_hdmi(IicPs, Address, Config[i].Reg, &Config[i].Init, 1);
	}
}



int som_hdmi_init( XIicPs *IicPs )
{

	iic_debug_xil_printf("SNOWLeo initialize hdmi starting...\n\r");
	// write Sii9134 configuration
	iic_writex( IicPs, ZC702_HDMI_ADDR1, zc702_hdmi_out_config1, ZC702_HDMI_OUT_LEN1 );

	iic_debug_xil_printf("i2c configure 0x39 done!\n\r");

	iic_writex( IicPs, ZC702_HDMI_ADDR2, zc702_hdmi_out_config2, ZC702_HDMI_OUT_LEN2 );

	iic_debug_xil_printf("i2c configure 0x3d done!\n\r");

	return XST_SUCCESS;
}


int nano_cmos_init( XIicPs *IicPs )
{
	int i;
	// write
	for(i=0;i<Config_Len_C;i++)
	{
		iic_write_cmos(IicPs, IIC_ADDR, &CMOS_Config[i][0],2, &CMOS_Config[i][2], 1);
	}

	return XST_SUCCESS;
}
